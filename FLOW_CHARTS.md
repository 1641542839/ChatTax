# 🔄 Checklist 功能流程图

## 📊 总览流程

```
        ┌──────────────────────────────────────┐
        │         用户访问应用                  │
        └─────────────┬────────────────────────┘
                      │
        ┌─────────────▼────────────────────────┐
        │    想要生成新清单？                   │
        └──────┬────────────────┬───────────────┘
               │ YES            │ NO
               │                │
   ┌───────────▼─────┐  ┌──────▼────────────────┐
   │ /checklist/      │  │ /checklist            │
   │ generate         │  │ (查看现有清单)         │
   └───────┬──────────┘  └──────┬────────────────┘
           │                    │
           │                    │
           ▼                    ▼
    [生成清单流程]        [查看清单流程]
```

---

## 1️⃣ 生成清单流程

```
┌─────────────────────────────────────────────────────────┐
│ 第 1 步：填写表单                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  用户填写：                                              │
│  • 就业状态（employed/self_employed/unemployed/retired） │
│  • 收入来源（salary, investment, rental, business...）   │
│  • 行业、地区                                            │
│  • 抚养人、投资、房产等                                   │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 第 2 步：提交表单                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  前端:                                                   │
│  const identityInfo = createIdentityInfo(...)           │
│  await generateChecklistFromAPI(userId, identityInfo)   │
│                                                          │
│  按钮显示: Loading... 🔄                                │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 第 3 步：API 请求                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  HTTP POST /api/checklist/generate                      │
│  {                                                       │
│    user_id: 1,                                          │
│    identity_info: {                                     │
│      employment_status: "employed",                     │
│      income_sources: ["salary", "investment"],          │
│      has_dependents: true,                              │
│      ...                                                │
│    }                                                    │
│  }                                                      │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 第 4 步：后端处理                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Router → Service → LLM Service                         │
│                                                          │
│  1. 验证请求参数                                         │
│  2. 调用 OpenAI GPT-4o                                  │
│  3. 生成 5-15 个个性化任务                               │
│  4. 保存到数据库                                         │
│  5. 返回 ChecklistResponse                              │
│                                                          │
│  生成时间: 约 3-5 秒 ⏱️                                  │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 第 5 步：前端接收响应                                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Response: 201 Created                                  │
│  {                                                       │
│    id: 5,                                               │
│    user_id: 1,                                          │
│    items: [                                             │
│      {                                                  │
│        id: "doc_001",                                   │
│        title: "Gather Income Statements",              │
│        status: "todo",                                  │
│        priority: "high",                                │
│        ...                                              │
│      },                                                 │
│      ... (9 more items)                                 │
│    ]                                                    │
│  }                                                      │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 第 6 步：更新 Store                                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Store 更新:                                             │
│  • tasks = response.items (转换为 Task 格式)             │
│  • currentChecklistId = response.id                     │
│  • isLoading = false                                    │
│                                                          │
│  显示 Toast: "🎉 个性化清单生成成功！"                    │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 第 7 步：路由跳转                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  router.push('/checklist')                              │
│                                                          │
│  自动跳转到清单页面 → 显示生成的任务 ✅                  │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 2️⃣ 查看清单流程

```
┌─────────────────────────────────────────────────────────┐
│ 第 1 步：页面加载                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  useEffect(() => {                                      │
│    initializeData()                                     │
│  }, [])                                                 │
│                                                          │
│  显示: Loading Spinner 🔄                               │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 第 2 步：尝试从 API 加载                                 │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  try {                                                  │
│    await loadUserChecklistsFromAPI(1)                   │
│    setDataSource('api')                                 │
│  }                                                      │
│                                                          │
│  HTTP GET /api/checklist/user/1                         │
│                                                          │
└────────┬────────────────────────────┬───────────────────┘
         │ 成功                        │ 失败
         │                            │
         ▼                            ▼
┌──────────────────┐        ┌─────────────────────────┐
│ API 模式         │        │ 本地模式                 │
├──────────────────┤        ├─────────────────────────┤
│                  │        │                         │
│ • 使用后端数据    │        │ • 使用默认数据           │
│ • 显示 🔗 API #5  │        │ • 显示 📁 本地数据       │
│ • 启用同步功能    │        │ • 禁用同步功能           │
│                  │        │                         │
└──────┬───────────┘        └────────┬────────────────┘
       │                             │
       └──────────┬──────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│ 第 3 步：渲染 UI                                         │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌────────────────────────────────────────────┐         │
│  │ ✅ Tax Preparation Checklist  🔗 API #5    │         │
│  │   [🚀 生成新清单] [🔄 刷新]                │         │
│  ├────────────────────────────────────────────┤         │
│  │ ✅ Overall Progress         3 / 10         │         │
│  │ [████████░░░░░░░░░░░░] 30% Complete       │         │
│  ├────────────────────────────────────────────┤         │
│  │ Filter: [All] [To Do] [Doing] [Done]      │         │
│  ├────────────────────────────────────────────┤         │
│  │ TaskCard #1                                │         │
│  │ TaskCard #2                                │         │
│  │ ...                                        │         │
│  └────────────────────────────────────────────┘         │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 3️⃣ 更新状态流程

```
┌─────────────────────────────────────────────────────────┐
│ 第 1 步：用户交互                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  用户点击任务复选框 ☑️                                   │
│                                                          │
│  TaskCard: handleToggle() 被触发                        │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 第 2 步：判断模式                                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  currentChecklistId 存在？                              │
│                                                          │
└────────┬────────────────────────────┬───────────────────┘
         │ YES (API 模式)              │ NO (本地模式)
         │                            │
         ▼                            ▼
┌──────────────────────┐    ┌──────────────────────────┐
│ API 同步流程         │    │ 本地更新流程              │
├──────────────────────┤    ├──────────────────────────┤
│                      │    │                          │
│ 步骤 2.1: 乐观更新    │    │ 直接调用:                │
│ • 立即更新本地 UI     │    │ toggleTaskStatus(id)    │
│ • 计算新状态          │    │                          │
│   todo → doing       │    │ 本地状态更新 ✅          │
│   doing → done       │    │                          │
│   done → todo        │    │                          │
│                      │    │                          │
│ UI 立即响应 ⚡        │    └──────────────────────────┘
│                      │
│ 步骤 2.2: 后台同步    │
│ • setIsUpdating(true)│
│ • API 请求           │
│                      │
│ PATCH /api/checklist/│
│ {id}/status          │
│ {                    │
│   item_id: "doc_001",│
│   status: "doing"    │
│ }                    │
│                      │
│ 步骤 2.3: 处理响应    │
│ • 成功 → 显示 toast  │
│ • 失败 → 回滚状态     │
│ • setIsUpdating(false)│
│                      │
└──────────────────────┘

详细的 API 同步流程:

┌─────────────────────────────────────────────────────────┐
│ 乐观更新（立即执行）                                     │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  updateTaskStatusInAPI(itemId, newStatus, userId)       │
│                                                          │
│  1. 立即更新本地 Store:                                  │
│     set(state => ({                                     │
│       tasks: state.tasks.map(task =>                    │
│         task.id === itemId                              │
│           ? { ...task, status: newStatus }              │
│           : task                                        │
│       )                                                 │
│     }))                                                 │
│                                                          │
│  2. UI 立即显示新状态（用户感觉很快）⚡                  │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 后台同步（异步执行）                                     │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  3. 发送 API 请求:                                       │
│     await checklistService.updateItemStatus(            │
│       checklistId, userId,                              │
│       { item_id: itemId, status: newStatus }            │
│     )                                                   │
│                                                          │
│  4. 等待服务器响应...                                    │
│                                                          │
└────────┬────────────────────────────┬───────────────────┘
         │ 成功                        │ 失败
         │                            │
         ▼                            ▼
┌──────────────────────┐    ┌──────────────────────────┐
│ 成功处理             │    │ 失败处理                  │
├──────────────────────┤    ├──────────────────────────┤
│                      │    │                          │
│ • 显示成功 toast     │    │ • 显示错误 toast         │
│   "✅ 状态已更新"    │    │   "更新失败，请重试"     │
│                      │    │                          │
│ • 状态已保存到数据库  │    │ • 回滚本地状态:          │
│                      │    │   await loadChecklist    │
│ • 其他设备可同步      │    │   FromAPI(...)          │
│                      │    │                          │
│ • 刷新页面不会丢失    │    │ • UI 恢复到之前的状态    │
│                      │    │                          │
└──────────────────────┘    └──────────────────────────┘
```

---

## 4️⃣ 错误处理流程

```
┌─────────────────────────────────────────────────────────┐
│ API 请求                                                 │
└────────┬────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│ 可能的错误                                               │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 1. 网络错误 (Network Error)                             │
│    • 后端服务未启动                                      │
│    • 网络连接中断                                        │
│                                                          │
│ 2. HTTP 错误                                            │
│    • 400 Bad Request - 参数错误                          │
│    • 404 Not Found - 资源不存在                          │
│    • 500 Server Error - 服务器错误                       │
│                                                          │
│ 3. 业务错误                                             │
│    • OpenAI API 限流                                     │
│    • 数据库连接失败                                      │
│    • 清单不存在                                          │
│                                                          │
└────────┬────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│ 错误捕获                                                 │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ try {                                                   │
│   await apiCall()                                       │
│ } catch (error) {                                       │
│   // 错误处理逻辑                                        │
│ }                                                       │
│                                                          │
└────────┬────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│ 用户友好的错误处理                                       │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 1. 显示错误消息                                          │
│    • message.error('更新失败，请重试')                   │
│    • Alert 组件显示详细错误                              │
│                                                          │
│ 2. 状态回滚                                             │
│    • 乐观更新失败 → 恢复之前的状态                       │
│    • 重新从 API 加载数据                                 │
│                                                          │
│ 3. 降级策略                                             │
│    • API 失败 → 自动切换到本地模式                       │
│    • 用户体验不受影响                                    │
│                                                          │
│ 4. 日志记录                                             │
│    • console.error() 记录错误                           │
│    • 方便调试                                           │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 关键决策点

### 决策 1: 使用哪种数据源？
```
页面加载
    │
    ├─ 尝试 API
    │   ├─ 成功 → API 模式（推荐）✅
    │   └─ 失败 → 本地模式（降级）⚠️
    │
    └─ 显示对应的标签
```

### 决策 2: 如何更新状态？
```
用户点击复选框
    │
    ├─ currentChecklistId 存在？
    │   ├─ YES → 使用 API 同步 ✅
    │   └─ NO → 仅本地更新 📁
    │
    └─ 更新 UI
```

### 决策 3: API 失败如何处理？
```
API 请求失败
    │
    ├─ 乐观更新？
    │   ├─ YES → 回滚状态 ↩️
    │   └─ NO → 显示错误 ❌
    │
    └─ 显示错误提示
```

---

## 📊 时间线

```
用户操作                API 模式                  本地模式
    │                      │                        │
    │ 点击复选框            │                        │
    ├──────────────────────▶                        │
    │                      │                        │
    │ 立即更新 UI (0ms)     │                        │
    │◀──────────────────────                        │
    │                      │                        │
    │                      │ API 请求                │
    │                      ├────────────────────▶   │
    │                      │                        │
    │                      │ 等待响应 (100-500ms)    │
    │                      │                        │
    │                      │ 响应返回                │
    │                      │◀────────────────────   │
    │                      │                        │
    │ 显示 Toast           │                        │
    │◀──────────────────────                        │
    │                      │                        │
    │ 完成 ✅              │                        │
```

---

## 🔄 完整循环

```
1. 生成清单
    ↓
2. 查看清单
    ↓
3. 更新任务状态
    ↓
4. 进度更新
    ↓
5. 所有任务完成
    ↓
6. 生成新清单（重新开始）
```

---

**流程图完成！** 🎉

这些流程图帮助你理解：
- ✅ 数据如何在前后端之间流动
- ✅ 用户操作如何触发 API 调用
- ✅ 错误如何被捕获和处理
- ✅ 状态如何在不同场景下更新
